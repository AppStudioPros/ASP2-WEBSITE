import React, { useState, useEffect, useRef } from 'react';\nimport './AIAvatarRealistic.css';\n\nconst BACKEND_URL = process.env.REACT_APP_BACKEND_URL || '';\n\nfunction AIAvatarRealistic() {\n  const [isListening, setIsListening] = useState(false);\n  const [isSpeaking, setIsSpeaking] = useState(false);\n  const [messages, setMessages] = useState([]);\n  const [inputText, setInputText] = useState('');\n  const [isStreaming, setIsStreaming] = useState(false);\n  const [voiceCommand, setVoiceCommand] = useState('');\n  const [avatarState, setAvatarState] = useState('idle'); // idle, thinking, speaking\n  \n  const recognitionRef = useRef(null);\n  const synthRef = useRef(window.speechSynthesis);\n  const currentStreamRef = useRef('');\n\n  // Initialize speech recognition\n  useEffect(() => {\n    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {\n      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;\n      const recognition = new SpeechRecognition();\n      recognition.continuous = false;\n      recognition.interimResults = false;\n      recognition.lang = 'en-US';\n\n      recognition.onresult = (event) => {\n        const transcript = event.results[0][0].transcript;\n        setVoiceCommand(transcript);\n        handleVoiceCommand(transcript);\n        setIsListening(false);\n      };\n\n      recognition.onerror = () => {\n        setIsListening(false);\n      };\n\n      recognition.onend = () => {\n        setIsListening(false);\n      };\n\n      recognitionRef.current = recognition;\n    }\n  }, []);\n\n  const handleVoiceCommand = (command) => {\n    const lowerCommand = command.toLowerCase();\n    \n    if (lowerCommand.includes('battle') || lowerCommand.includes('arena')) {\n      const battleBtn = document.querySelector('[data-testid=\"nav-battle\"]');\n      if (battleBtn) battleBtn.click();\n      speak('Opening Battle Arena');\n      return;\n    }\n    \n    if (lowerCommand.includes('home') || lowerCommand.includes('avatar')) {\n      const heroBtn = document.querySelector('[data-testid=\"nav-hero\"]');\n      if (heroBtn) heroBtn.click();\n      speak('Going to home');\n      return;\n    }\n    \n    setInputText(command);\n    handleSendMessage(command);\n  };\n\n  const toggleListening = () => {\n    if (!recognitionRef.current) {\n      alert('Speech recognition not supported in this browser');\n      return;\n    }\n\n    if (isListening) {\n      recognitionRef.current.stop();\n      setIsListening(false);\n    } else {\n      recognitionRef.current.start();\n      setIsListening(true);\n      setVoiceCommand('');\n    }\n  };\n\n  const speak = (text) => {\n    if (synthRef.current) {\n      synthRef.current.cancel();\n      \n      const utterance = new SpeechSynthesisUtterance(text);\n      utterance.rate = 1.0;\n      utterance.pitch = 1.0;\n      utterance.volume = 1.0;\n      \n      utterance.onstart = () => {\n        setIsSpeaking(true);\n        setAvatarState('speaking');\n      };\n      utterance.onend = () => {\n        setIsSpeaking(false);\n        setAvatarState('idle');\n      };\n      \n      synthRef.current.speak(utterance);\n    }\n  };\n\n  const handleSendMessage = async (textToSend) => {\n    const messageText = textToSend || inputText;\n    if (!messageText.trim()) return;\n\n    const userMessage = { role: 'user', content: messageText };\n    setMessages(prev => [...prev, userMessage]);\n    setInputText('');\n    setIsStreaming(true);\n    setAvatarState('thinking');\n    currentStreamRef.current = '';\n\n    try {\n      const response = await fetch(`${BACKEND_URL}/api/ai/claude/stream`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          messages: [...messages, userMessage],\n          session_id: 'avatar-' + Date.now(),\n        }),\n      });\n\n      const reader = response.body.getReader();\n      const decoder = new TextDecoder();\n      let assistantMessage = { role: 'assistant', content: '' };\n      \n      setMessages(prev => [...prev, assistantMessage]);\n\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) break;\n\n        const chunk = decoder.decode(value);\n        const lines = chunk.split('\\n');\n\n        for (const line of lines) {\n          if (line.startsWith('data: ')) {\n            try {\n              const data = JSON.parse(line.slice(6));\n              \n              if (data.token) {\n                currentStreamRef.current += data.token;\n                setMessages(prev => {\n                  const newMessages = [...prev];\n                  newMessages[newMessages.length - 1].content = currentStreamRef.current;\n                  return newMessages;\n                });\n              }\n              \n              if (data.done) {\n                speak(currentStreamRef.current);\n              }\n            } catch (e) {}\n          }\n        }\n      }\n    } catch (error) {\n      console.error('Error:', error);\n      setMessages(prev => [\n        ...prev,\n        { role: 'assistant', content: 'Sorry, there was an error processing your request.' },\n      ]);\n      setAvatarState('idle');\n    } finally {\n      setIsStreaming(false);\n    }\n  };\n\n  return (\n    <div className=\"realistic-avatar-container\" data-testid=\"realistic-avatar\">\n      {/* Realistic Avatar */}\n      <div className={`realistic-avatar ${avatarState} ${isListening ? 'listening' : ''}`}>\n        <div className=\"avatar-hologram\">\n          {/* Holographic frame */}\n          <div className=\"holo-frame\"></div>\n          \n          {/* Avatar face/robot */}\n          <div className=\"avatar-face\">\n            <div className=\"face-outline\">\n              {/* Eyes */}\n              <div className=\"eyes\">\n                <div className=\"eye left\">\n                  <div className=\"pupil\"></div>\n                </div>\n                <div className=\"eye right\">\n                  <div className=\"pupil\"></div>\n                </div>\n              </div>\n              \n              {/* Mouth */}\n              <div className=\"mouth\">\n                <div className=\"mouth-line\"></div>\n              </div>\n              \n              {/* Tech details */}\n              <div className=\"tech-details\">\n                <div className=\"scan-line\"></div>\n                <div className=\"circuit-pattern\"></div>\n              </div>\n            </div>\n          </div>\n          \n          {/* Status indicator */}\n          <div className=\"status-indicator\">\n            {avatarState === 'idle' && 'ðŸ¤– READY'}\n            {avatarState === 'thinking' && 'ðŸ§  THINKING...'}\n            {avatarState === 'speaking' && 'ðŸ’¬ SPEAKING'}\n            {isListening && 'ðŸŽ¤ LISTENING'}\n          </div>\n        </div>\n        \n        {/* Voice waves when speaking */}\n        {isSpeaking && (\n          <div className=\"voice-waves\">\n            <div className=\"wave\"></div>\n            <div className=\"wave\"></div>\n            <div className=\"wave\"></div>\n          </div>\n        )}\n      </div>\n\n      {/* Chat Interface */}\n      <div className=\"realistic-chat-container glass-card\">\n        <div className=\"chat-header\">\n          <div className=\"header-title\">\n            <h3>AI ASSISTANT</h3>\n            <span className=\"status-badge\">ONLINE</span>\n          </div>\n          <button\n            className={`mic-button ${isListening ? 'active' : ''}`}\n            onClick={toggleListening}\n            data-testid=\"mic-button\"\n            disabled={isStreaming}\n          >\n            {isListening ? 'ðŸŽ¤ STOP' : 'ðŸŽ¤ VOICE'}\n          </button>\n        </div>\n\n        <div className=\"chat-messages\">\n          {messages.length === 0 && (\n            <div className=\"welcome-message\">\n              <p className=\"welcome-title\">ðŸ‘‹ GREETINGS, HUMAN</p>\n              <p>I am your AI assistant, powered by advanced neural networks.</p>\n              <div className=\"command-examples\">\n                <p>Try voice commands:</p>\n                <div className=\"command-chip\">\"Go to battle arena\"</div>\n                <div className=\"command-chip\">\"What can you do?\"</div>\n              </div>\n            </div>\n          )}\n          {messages.map((msg, idx) => (\n            <div key={idx} className={`message ${msg.role}`}>\n              <div className=\"message-avatar\">\n                {msg.role === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–'}\n              </div>\n              <div className=\"message-content\">\n                {msg.content || '...'}\n              </div>\n            </div>\n          ))}\n          {isStreaming && (\n            <div className=\"streaming-indicator\">\n              <span></span><span></span><span></span>\n            </div>\n          )}\n        </div>\n\n        <div className=\"chat-input\">\n          <input\n            type=\"text\"\n            value={inputText}\n            onChange={(e) => setInputText(e.target.value)}\n            onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}\n            placeholder=\"Type your message or use voice...\"\n            disabled={isStreaming}\n            data-testid=\"chat-input\"\n          />\n          <button\n            onClick={() => handleSendMessage()}\n            disabled={isStreaming || !inputText.trim()}\n            data-testid=\"send-button\"\n            className=\"send-button\"\n          >\n            âž¤\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default AIAvatarRealistic;\n